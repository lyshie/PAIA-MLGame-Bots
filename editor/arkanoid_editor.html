<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Arkanoid map editor for PAIA-Desktop</title>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css">
    <style>
        .draggable {
            width: 25px;
            height: 10px;
            float: left;
            margin: 0px;
            display: block;
            position: absolute;
        }

        .disable {
            filter: grayscale(1);
        }

        .brick {
            background-color: orange;
            background-image: radial-gradient(ellipse, yellow, orange);
            border: 0px solid black;
        }

        .hard-brick {
            background-color: red;
            background-image: radial-gradient(ellipse, yellow, red);
            border: 0px solid black;
        }

        .ui-widget-header p,
        .ui-widget-content p {
            margin: 0px;
            padding: 0px;
        }

        #snaptarget {
            height: 500px;
            width: 200px;
            padding: 0px;
            background-color: #0d0d0d;
            border: 1px solid black;
            float: right;
            margin-right: 10px;
        }

        .column-left {
            left: 0%;
            width: 50%;
            float: left;
        }

        .column-right {
            left: 50%;
            width: 50%;
            float: left;
        }

        #map {
            background-color: #c0c0c0;
        }

        #help {
            margin-right: 20px;
            float: right;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.js"></script>
    <script>
        $(function()
        {

            function download(filename, text)
            {
                var element = document.createElement('a');
                element.setAttribute('href',
                    'data:text/plain;charset=utf-8,' +
                    encodeURIComponent(text));
                element.setAttribute('download', filename);

                element.style.display = 'none';
                document.body.appendChild(element);

                element.click();

                document.body.removeChild(element);
            }

            // 自動貼齊 水平5 垂直10
            $(".brick").draggable(
            {
                grid: [5, 10]
            });

            // 切換硬磚塊
            $(document).on('click', '.brick', function()
            {
                $(this).toggleClass('hard-brick');
            });


            // 下載檔案
            $("#generate").click(function()
            {
                $("#map").empty();
                $("#map").append(parseInt($("#offset_x").val()) +
                    " " +
                    parseInt($("#offset_y").val()) +
                    " -1" + "\r\n"
                );

                $('.brick').each(function(index, val)
                {
                    var target_left = $("#snaptarget")
                        .offset().left;
                    var target_top = $("#snaptarget")
                        .offset().top;

                    var _left = Math.round($(this).offset()
                        .left - target_left - 1);
                    var _top = Math.round($(this).offset()
                        .top - target_top - 1);
                    // 硬磚塊
                    var _hard = $(this).hasClass(
                        'hard-brick') ? 1 : 0;

                    if ((_left >= 0 && _left <= 175) &&
                        (_top >= 0 && _top <= 490))
                    {
                        // 有效磚塊
                        $(val).removeClass('disable');

                        $("#map").append(_left + " " +
                            _top + " " + _hard +
                            "\r\n");
                    }
                    else
                    {
                        // 無效磚塊
                        $(val).addClass('disable');
                    }

                });

                // 下載關卡檔案
                var level = parseInt($("#level").val());
                download(level + ".dat", $("#map").text());
            });

            $("#snaptarget").dblclick(function(e)
            {
                brick = $(
                    '<div class="draggable ui-widget-content brick">'
                ).clone().draggable(
                {
                    grid: [5, 10]
                });

                brick.appendTo(this);

                var _left = brick.offset().left;
                var _top = brick.offset().top;
                //console.log(_left, _top);
            });
        });
    </script>
</head>

<body>

    <div class="column-left">
        <div id="snaptarget" class="ui-widget-header">
        </div>
        <div id="help">
            <p>Arkanoid map editor for <a href="https://github.com/PAIA-Playful-AI-Arena/Paia-Desktop"
                    target="_blank">PAIA-Desktop</a> <a href="https://github.com/lyshie/PAIA-MLGame-Bots"
                    target="_blank">@lyshie</a></p>
            <ol>
                <li>遊戲背景點兩下產生新的<span style="color:orange">磚塊</span></li>
                <li>拖曳磚塊可設定位置</li>
                <li>點擊磚塊切換成<span style="color:red">硬</span>磚塊</li>
            </ol>
        </div>
    </div>
    <div class="column-right">
        <label for="level">關卡名稱：</label><input type="number" id="level" value="101"
            min="0" max="999"></input><br>
        <label for="offset_x">X-軸偏移：</label><input type="number" id="offset_x"
            value="0" min="0" max="200"></input><br>
        <label for="offset_y">Y-軸偏移：</label><input type="number" id="offset_y"
            value="0" min="0" max="500"></input><br>
        <button type="button" id="generate">下載</button>
        <pre id="map"></pre>
    </div>
</body>

</html>
